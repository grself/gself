---
title: "Math Transfer"
author: "George Self"
date: 2018-09-11T08:00:00-07:00
description: "-- A look at the AZ Assist data for math transfer students --"
categories: ["r"]
tags: ["math","success","transfer"]
---

```{r setup, include=FALSE}
# Load some libraries
library(tidyverse)
library(here)
library(ggplot2)
library(plotly)
library(ggalluvial) # for Sankey plot
library(reshape2)

# Set the rproj home directory
here::here()
```

---
The state of Arizona maintains a database, named ASSIST, that contains information about courses completed by students in public colleges/universities in Arizona. For example, if a student completed MAT 220, Calculus I, at Cochise College and another student completed MAT 243, Discrete Math Structures, at Arizona State University information about both of those classes would be stored in the ASSIST database. In addition, all of the classes completed by any Arizona student can be found so it is possible to "follow" Cochise College students to the University to see how well they are doing and, of course, how well we are doing in teaching those subjects.

This report is the first in a planned series of several that analyzes how well the Cochise College students do at the university as they continue their education. In this post, I'll take a look at mathematics classes. The data available to me dates from 2010 to 2016 so the number of students analyzed is fairly large.

```{r getMathData, echo=FALSE, message=FALSE, warning=FALSE}

# First, find all records in a selected discipline
df <- read_csv("crs_prog_orig.csv") %>%
  select(assist_id
         ,semester 
         ,instcd 
         ,course_prefix
         ,course_number 
         ,course_title
         ,grade 
         ) %>% # keep only the fields of interest
  filter(
    course_prefix %in% c('MAT','MATH') # Get only the math courses
  ) %>%
  group_by(assist_id) %>% # group by student ID
  filter(n()>1) %>% # Keep records where students took more than one class
  arrange(semester) %>% # order by semester
  group_by(assist_id, instcd) %>% # group by student and institution
  slice(c(1, n())) %>% # keep only pairs of first/last for each institution
  ungroup() %>% # ungroup
  group_by(assist_id) %>% # group by student
  filter(n()>3) %>% # Keep only students with both cc an univ records
  ungroup() %>% # ungroup
  group_by(assist_id, instcd) %>% # group by student and institution
  slice(n()) # keep only the last record of each group

# Combine every two rows in a single row
df2 <- cbind(df[seq(1,nrow(df), by=2),], df[seq(2,nrow(df), by=2),]) %>%
  select(-assist_id1) %>% # this removes the student ID from the university side of the row
  filter(instcd1 != '104425') # remove the reverse credit classes

```


First, let me compare the grade spread for all Cochise College mathematics classes to all university mathematics classes. Keep in mind that the only students who are contributing to this analysis are those who took at least one college-level mathematics class at Cochise College and then took at least one higher-division mathematics class at the university, so it does not include all transfer students. Also, note that the universities issue a grade of "E" rather than "F" but they are equivalent.

```{r makeBarPlot, echo=FALSE, message=FALSE, warning=FALSE}

# calculate the university grade frequencies
ugra <- table(df2$grade1)
univ <- as.vector(c(
    sum(ugra["A"], ugra["A-"], ugra["A+"], na.rm = TRUE),
    sum(ugra["B"], ugra["B-"], ugra["B+"], na.rm = TRUE),
    sum(ugra["C"], ugra["C-"], ugra["C+"], na.rm = TRUE),
    sum(ugra["D"], ugra["D-"], ugra["D+"], na.rm = TRUE),
    sum(ugra["E"], ugra["E-"], ugra["E+"], na.rm = TRUE),
    sum(ugra["W"], ugra["NG"], ugra["NR"], na.rm = TRUE)
  ))

# calculate the cc grade frequencies
cc <- as.vector(c(
    sum(ugra["A"], na.rm = TRUE),
    sum(ugra["B"], na.rm = TRUE),
    sum(ugra["C"], na.rm = TRUE),
    sum(ugra["D"], na.rm = TRUE),
    sum(ugra["E"], ugra["F"], na.rm = TRUE),
    sum(ugra["W"], ugra["NR"], na.rm = TRUE)
  ))



#cc <- as.vector(table(df2$grade))

# Create a data.frame with the grades and both frequencies
grafreq <- data.frame(
  Grade = factor(c("A","B","C","D","F","W")),
  University = univ,
  Cochise = cc
  )

# Melt the data.frame to make it work in ggplot
gralong <- melt(grafreq, id.vars='Grade') 

names(gralong) <- c("Grade","Institution","Number")

p <- ggplot(data = gralong, aes(x = Grade, y = Number)) +
  geom_col(position = position_dodge()
           ,color = "darkgray"
           ,aes(fill = Institution)
           ) +
  scale_fill_brewer(palette = "Pastel2") + #Color Brewer Palette
  theme_bw() +
  labs(title = "Math Grade Spread")

ggplotly(p)


```


## Alluvial Plot

The following plot shows the success of our students who transferred to ASU or UofA. This plot only shows course progression tracks that included more than three students and since no single track between Cochise College and NAU has more than three students that institution does not appear in this plot.

```{r Alluvial, echo=FALSE, message=FALSE, warning=FALSE}

alluv <- ungroup(df2) %>% 
  select(course_prefix, course_number, instcd1, course_prefix1, course_number1, grade1) %>%
  rename('univ' = 'instcd1') %>%
  unite(cc_course, course_prefix, course_number) %>%
  unite(u_course, course_prefix1, course_number1) %>%
  mutate(pass_fail = ifelse(
      grade1 == 'A+' 
    | grade1 == 'A' 
    | grade1 == 'A-' 
    | grade1 == 'B+' 
    | grade1 == 'B' 
    | grade1 == 'B-' 
    | grade1 == 'C+'
    | grade1 == 'C'
    | grade1 == 'C-'
    , 'Pass'
    , 'Fail')) %>%
  select(-grade1) %>%
  arrange(univ,cc_course,u_course) %>%
  count(univ, cc_course,u_course,pass_fail) %>%
  filter(n > 3) %>%
  rename(Freq = 'n')

ggplot(alluv,
       aes(y = Freq, axis1 = cc_course, axis2 = univ, axis3 = u_course)) +
  geom_alluvium(aes(fill = pass_fail), width = 1/12) +
  geom_stratum(width = 1/12, fill = "black", color = "grey") +
  geom_label(stat = "stratum", label.strata = TRUE) +
  scale_x_discrete(limits = c("CC Class", "Univ", "U Class"), expand = c(.05, .05)) +
  scale_fill_brewer(type = "qual", palette = "Set1") +
  ggtitle("Math Tracks")

# Note: no plotly function for an alluvial plot.

```


The scale on the left side of the diagram is a cumulative weight of the total number of tracks between Cochise College and the two universities. In total, 29 tracks were found that mapped the progress of 120 students. For example, several students completed MAT 220 at Cochise College and later completed MATH 129 at the University of Arizona. Other tracks can be followed from Cochise College to both ASU and UA. At first glance, it would seem that our math students are more successful at ASU than UA, even given the generally higher level of math class completed at ASU.