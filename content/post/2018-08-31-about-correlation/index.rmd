---
title: "About Correlation"
author: "George Self"
date: 2018-08-31T08:00:00-07:00
description: "-- How to determine the correlation among a lot of variables at once! --"
categories: ["r"]
tags: ["correlation","correlogram","ipeds","peers"]
---

```{r setup, include=FALSE}
# Load some libraries
library(tidyverse)
library(here)
library(plotly)
library(kableExtra)
library(corrgram)
library(xtable)
library(corrplot)

# Set the rproj home directory
here::here()
```

```{r prepDF, include=FALSE}

df <- read_csv("peers.csv") %>%
  select(
    id = "unitid"
    ,name = "institution name"
    ,year = "year"
    ,fips = "HD2016.FIPS state code"
    ,sect = "HD2016.Sector of institution"
    ,deg = "HD2016.Degree-granting status"
    ,tuition = "DRVIC2016.Tuition and fees, 2016-17"
    ,priInOn = "DRVIC2016.Total price for in-state students living on campus 2016-17"
    ,priOutOn = "DRVIC2016.Total price for out-of-state students living on campus 2016-17"
    ,priInOff = "DRVIC2016.Total price for in-state students living off campus (not with family)  2016-17"
    ,priInOffFam = "DRVIC2016.Total price for in-state students living off campus (with family)  2016-17"
    ,size = "HD2016.Institution size category"
    ,regn = "HD2016.Bureau of Economic Analysis (BEA) regions"
    ,enrlTtl = "DRVEF2016.Total  enrollment"
    ,enrlFT = "DRVEF2016.Full-time enrollment"
    ,enrlPT = "DRVEF2016.Part-time enrollment"
    ,fteFall = "DRVEF2016.Full-time equivalent fall enrollment"
    ,frstEnrl = "DRVEF2016.First-time degree/certificate-seeking undergraduate enrollment"
    ,tranEnrl = "DRVEF2016.Transfer-in degree/certificate-seeking undergraduate enrollment"
    ,contEnrl = "DRVEF2016.Continuing degree/certificate-seeking undergraduate enrollment"
    ,nodegEnrl = "DRVEF2016.Nondegree/certificate-seeking undergraduate enrollment"
    ,enrlInd = "DRVEF2016.Percent of total enrollment that are American Indian or Alaska Native"
    ,enrlAsn = "DRVEF2016.Percent of total enrollment that are Asian"
    ,enrlBlk = "DRVEF2016.Percent of total enrollment that are Black or African American"
    ,enrlHsp = "DRVEF2016.Percent of total enrollment that are Hispanic/Latino"
    ,enrlHaw = "DRVEF2016.Percent of total enrollment that are Native Hawaiian or Other Pacific Islander"
    ,enrlWhi = "DRVEF2016.Percent of total enrollment that are White"
    ,enrlTwo = "DRVEF2016.Percent of total enrollment that are two or more races"
    ,enrlUnk = "DRVEF2016.Percent of total enrollment that are Race/ethnicity unknown"
    ,enrlAli = "DRVEF2016.Percent of total enrollment that are Nonresident Alien"
    ,enrlPac = "DRVEF2016.Percent of total enrollment that are Asian/Native Hawaiian/Pacific Islander"
    ,enrlFem = "DRVEF2016.Percent of total enrollment that are women"
    ,sfr = "EF2016D.Student-to-faculty ratio"
    ,retFT = "EF2016D.Full-time retention rate, 2016"
    ,retPT = "EF2016D.Part-time retention rate, 2016"
    ,enrlAdlt = "DRVEF2016.Adult age (25-64) enrollment, all students"
    ,enrl18 = "DRVEF2016.Percent of undergraduate enrollment under 18"
    ,enrl1824 = "DRVEF2016.Percent of undergraduate enrollment 18-24"
    ,enrl2564 = "DRVEF2016.Percent of undergraduate enrollment, 25-64"
    ,enrl65 = "DRVEF2016.Percent of undergraduate enrollment over 65"
    ,frstInNum = "DRVEF2016.Number of first-time undergraduates - in-state"
    ,frstInPct = "DRVEF2016.Percent of first-time undergraduates - in-state"
    ,frstOutNum = "DRVEF2016.Number of first-time undergraduates - out-of-state"
    ,frstOutPct = "DRVEF2016.Percent of first-time undergraduates - out-of-state"
    ,deOnly = "DRVEF2016.Percent of students enrolled exclusively in distance education courses"
    ,deSome = "DRVEF2016.Percent of students enrolled in some but not all distance education courses"
    ,dePct = "DRVEF2016.Percent of students not enrolled in any distance education courses"
    ,asoc = "DRVC2016.Associate's degree"
    ,cert1 = "DRVC2016.Certificates of less than 1-year"
    ,cert12 = "DRVC2016.Certificates of 1 but less than 2-years"
    ,asocNum = "DRVC2016.Number of students receiving an Associate's degree"
    ,cert1Num = "DRVC2016.Number of students receiving a certificate of less than 1-year"
    ,cert12Num = "DRVC2016.Number of students receiving a certificate of 1 but less than 4-years"
    ,gradTtl = "DRVGR2016.Graduation rate, total cohort"
    ,gradMal = "DRVGR2016.Graduation rate, men"
    ,gradFem = "DRVGR2016.Graduation rate, women"
    ,tranTtl = "DRVGR2016.Transfer-out rate, total cohort"
    ,gradPell = "DRVGR2016.Pell Grant recipients - Overall graduation rate within 150 percent of normal time"
    ,gradNoFa = "DRVGR2016.Did not receive Pell Grants or Subsidized Stafford Loans - Overall graduation rate within 150 percent of normal time"
    ,grad100 = "GR200_16.Graduation rate - degree/certificate within 100% of normal time"
    ,faPct = "SFA1516.Percent of full-time first-time undergraduates awarded any financial aid"
    ,faFedPct = "SFA1516.Percent of full-time first-time undergraduates awarded federal, state, local or institutional grant aid"
    ,faFedAmt = "SFA1516.Average amount of federal, state, local or institutional grant aid awarded"
    ,pellPct = "SFA1516.Percent of full-time first-time undergraduates awarded Pell grants"
    ,pellAmt = "SFA1516.Average amount of Pell grant aid awarded to full-time first-time undergraduates"
    ,loanPct = "SFA1516.Percent of full-time first-time undergraduates awarded student loans"
    ,loanAmt = "SFA1516.Average amount of student loans awarded to full-time first-time undergraduates"
    ,revnu = "DRVF2016.Core revenues, total dollars (GASB)"
    ,revnuTuiPct = "DRVF2016.Tuition and fees as a percent of core revenues (GASB)"
    ,revnuStPct = "DRVF2016.State appropriations as percent of core revenues  (GASB)"
    ,revnuLocPct = "DRVF2016.Local appropriations as a percent of core revenues (GASB)"
    ,revnuTuiFte = "DRVF2016.Revenues from tuition and fees per FTE (GASB)"
    ,revnuStFte = "DRVF2016.Revenues from state appropriations per FTE (GASB)"
    ,revnuLocFte = "DRVF2016.Revenues from local appropriations per FTE (GASB)"
    ,exp = "DRVF2016.Core expenses, total dollars (GASB)"
    ,expInstrPct = "DRVF2016.Instruction expenses as a percent of total core expenses (GASB)"
    ,expAcSpPct = "DRVF2016.Academic support expenses as a percent of total core expenses (GASB)"
    ,expStSvPct = "DRVF2016.Student service expenses as a percent of total core expenses (GASB)"
    ,expInSpPct = "DRVF2016.Institutional support expenses as a percent of total core expenses (GASB)"
    ,expInstrFte = "DRVF2016.Instruction expenses per FTE  (GASB)"
    ,expAcSpFte = "DRVF2016.Academic support expenses per FTE (GASB)"
    ,expStSvFte = "DRVF2016.Student service expenses per FTE (GASB)"
    ,expInSpFte = "DRVF2016.Institutional support expenses per FTE (GASB)"
    ,expSalPct = "DRVF2016.Salaries and wages for core expenses as a percent of total core expenses (GASB)"
    ,expSalInstr = "DRVF2016.Salaries and wages for instruction as a percent of total expenses for instruction (GASB)"
    ,expSalAcSp = "DRVF2016.Salaries and wages for academic support as a percent of total expenses for academic support (GASB)"
    ,expSalStSv = "DRVF2016.Salaries and wages for student services as a percent of total expenses for student services (GASB)"
    ,expSalInSp = "DRVF2016.Salaries and wages for institutional support as a percent of total expenses for institutional support (GASB)"
    ,expSalAvr = "DRVHR2016.Average salary equated to 9 months of full-time instructional staff - all ranks"
    ,fteStf = "DRVHR2016.Total FTE staff"
    ,fteInstr = "DRVHR2016.Instructional FTE"
    ,fteLib = "DRVHR2016.Librarians, Curators, and Archivists/Student and Academic Affairs and Other Education Services FTE"
    ,fteStSv = "DRVHR2016.Student and Academic Affairs and Other Education Services FTE"
    ,fteMgmt = "DRVHR2016.Management FTE"
    ,fteBus = "DRVHR2016.Business and Financial Operations FTE"
    ,fteCmptr = "DRVHR2016.Computer, Engineering, and Science FTE"
    ,fteAdmSp = "DRVHR2016.Service, sales, office/admin support, natural resources, construction, maintenance, production, transportation & materials moving FTE"
    ,priFa = "SFA1516.Average net price-students awarded grant or scholarship aid, 2015-16"
    ,phyBks = "DRVAL2016.Physical books as a percent of the total library collection"
    ,phyMed = "DRVAL2016.Physical media as a percent of the total library collection"
    ,phySer = "DRVAL2016.Physical serials as a percent of the total library collection"
    ,dbLib = "DRVAL2016.Databases as a percent of the total library collection"
    ,libSal = "DRVAL2016.Salaries and wages from the library budget as a percent of total library expenditures"
    ,libBkPrch = "DRVAL2016.One-time purchases of books, serial backfiles, and other materials as a percent of total library expenditures"
    ,expLibFte = "DRVAL2016.Total library expenditures per FTE"
    ,addr = "HD2016.Street address or post office box"
    ,city = "HD2016.City location of institution"
    ,state = "HD2016.State abbreviation"
    ,zip = "HD2016.ZIP code"
    ,url = "HD2016.Institution's internet website address"
    ,county = "HD2016.County name"
    ,long = "HD2016.Longitude location of institution"
    ,lat = "HD2016.Latitude location of institution"
  )

prices <- df %>%
  select(
    tuition
    ,'Tui' = tuition
    ,'Pri1' = priInOff
    ,'Pri2' = priInOffFam
    ,'Enr' = enrlTtl
    ,'FT' = enrlFT
    ,'PT' = enrlPT
  )


```


One of the main preoccupations for data researchers is to attempt to find some sort of correlation, or relationship, between two or more attributes of a data frame. The calculated correlation is a number between -1.0 and +1.0 where correlations close to 0.0 are very weak while correlations near the extremes are strong. The type of correlation that can be calculated is dependent on the type of data being compared since the process for categorical data is fundamentally different than that for continuous data. *R* provides several useful methods for calculating correlations and researchers need to be familiar with each of them.

## Basic Correlations

For this blog post, the Cochise College IPEDs Peer data frame will be used. That data frame was first seen in *Introduction to Our IPEDS Peers* (August 24, 2018). That data frame includes 113 attributes for 29 colleges and it is natural to wonder if any of those attributes are related to each other. For example, it is reasonable to assume that the number of full-time students is related to the expense of instruction, that is, as one increases the other should also increase. In fact, the correlation between those two attributes is `r round(cor(df$exp,df$expSalInstr),3)`, which is rather weak but does exist.

However, there may be many other unexpected correlations lurking in that data frame. It would be possible to calculate the correlation between each pair of attributes one at a time, but that would be very time-consuming (and, frankly, mind-numbing). However, R creates a correlation matrix if more than two variables are compared at one time. As an example, I extracted information about the price of attending each of the colleges in the peer group and compared those prices to the enrollments to try to determine if there was a relationship between the price of attending and the number of students enrolling.

```{r corMatrix, echo=FALSE, results='asis'}

priDef <- data.frame(
  "Code" = c(
             "Tui"
             ,"Pri1"
             ,"Pri2"
             ,"Enr"
             ,"FT"
             ,"PT"
             ),
  "Def" = c(
             "Tuition"
             ,"Price for In-State Students Living Off-Campus Living Alone"
             ,"Price for In-State Students Living Off-Campus Living With Family"
             ,"Total Enrollment"
             ,"Number of Full-Time Students"
             ,"Number of Part-Time Students"
             )
)

# priDef %>% 
#   kable("html", align = c("l","l")) %>%
#     kable_styling(bootstrap_options = "striped",
#                 full_width = F,
#                 position = "center"
#                 )

priDef %>%
  kable("html", align = c("l","l")) %>%
  kable_styling(bootstrap_options = "striped"
                ,full_width = F
                ,position = "center"
                ) %>%
  row_spec(0, color = 'orange', background = 'brown')



corMat <- data.frame(
  "Matrix" = c(
         "Tui"
         ,"Pri1"
         ,"Pri2"
         ,"Enr"
         ,"FT"
         ,"PT"
  ),
  "Tui" = c(
    "1"
    ,"0.108"
    ,"0.215"
    ,"-0.272"
    ,"0.106"
    ,"-0.326"
  ),
  "Pri1" = c(
    " "
    ,"1"
    ,"0.717"
    ,"-0.142"
    ,"-0.038"
    ,"-0.166"
  ),
  "Pri2" = c(
    " "
    ," "
    ,"1"
    ,"0.066"
    ,"0.354"
    ,"-0.027"
  ),
  "Enr" = c(
    " "
    ," "
    ," "
    ,"1"
    ,"0.444"
    ,"0.968"
  ),
  "FT" = c(
    " "
    ," "
    ," "
    ," "
    ,"1"
    ,"0.205"
  ),
  "PT" = c(
    " "
    ," "
    ," "
    ," "
    ," "
    ,"1"
  )
)

corMat %>% 
  kable("html",align = c("l","r","r","r","r","r","r")) %>%
    kable_styling(bootstrap_options = "striped",
                full_width = F,
                position = "center"
                ) %>%
    column_spec(1, bold = TRUE) %>%
    row_spec(0, color = 'orange', background = 'brown')


```



From the above matrix, I could tell that there is a very strong correlation between enrollment and the number of part-time students (0.968), which means that a lot of the enrollment is driven by part-time students. I also notice a moderate negative correlation between the tuition and the number of part-time students (-0.326). This would indicate that as tuition increases the number of part-time students decreases.

## Correlograms

All of this is fine and easy enough to do for just the six attributes in the above table, but what if I wanted to analyze more attributes, maybe a dozen at one time? The table full of numbers would quickly become overwhelming, but *R* provides a great tool for visually evaluating a correlation matrix: *correlogram.* The following illustration is a correlogram for 21 enrollment-related attributes from the peers' data frame. The attribute names are abbreviated in the main diagonal then the upper and lower triangles present the correlations using two different methods.

In the lower triangle, the correlation calculations are shown using a color code. The brighter the blue color then the greater the positive correlation while the brighter the red color the greater the negative correlation. I can then look for bright colors to quickly isolate correlations of interest. To read the correlogram using the colored squares in the lower triangle follow one column up to the diagonal to see one of the factors that are being correlated and then right to the diagonal to see the other factor. The same type of process can be used with the numeric data in the top triangle by following a row across to the left and a column down to find the two factors that are correlated for that number. For example, near the top of the diagonal, the value 0.44 is found. This is a reasonably high positive correlation so it is in bright blue. From that number, the factor to the left is “Ttl” and the factor down is “FT” so this is a correlation between total enrollment and the number of full-time students. This, by the way, is also what was found in the correlation matrix presented above.

Using a correlogram makes it easy to quickly find correlations of interest in even a fairly large data frame. As just one last example, I noticed that the students pursuing no degree (abbreviated as “NoDeg” in the diagonal) have a very strong correlation with part-time students, indicating that there is some sort of relationship between being part-time and not declaring a major.

```{r setUpCorrGram1, include=FALSE}

corEnrl <- df %>%
  select(
    tuition
    ,'Ttl' = enrlTtl
    ,'FT' = enrlFT
    ,'PT' = enrlPT
    ,'NoDeg' = nodegEnrl
    # ,'Ind' = enrlInd
    # ,'Asn' = enrlAsn
    # ,'Blk' = enrlBlk
    # ,'Hsp' = enrlHsp
    # ,'Haw' = enrlHaw
    # ,'Whi' = enrlWhi
    ,'TwoRc' = enrlTwo
    ,'UnkRc' = enrlUnk
    ,'Alien' = enrlAli
    ,'Pac' = enrlPac
    ,'Fem' = enrlFem
    ,'Adlt' = enrlAdlt
    ,'18' = enrl18
    ,'18-24' = enrl1824
    ,'25-64' = enrl2564
    ,'65' = enrl65
  )

```


```{r printCorrGram1, echo=FALSE}


corrgram(corEnrl,
         upper.panel = panel.cor
         ,lower.panel = panel.fill
         )

# corrplot(as.matrix(corEnrl), is.corr = FALSE, method="color")
# 
# col <- colorRampPalette(c("#BB4444", "#EE9988", "#FFFFFF", "#77AADD", "#4477AA"))
# corrplot(as.matrix(corEnrl)
#          ,is.corr = FALSE
#          ,method='color'
#          ,col=col(200)
#          ,type="upper"
#          #,order="hclust"
#          ,addCoef.col = "black"
#          # Add coefficient of correlation
#          ,tl.col="black"
#          ,tl.srt=45 #Text label color and rotation
#          # Combine with significance
#          #,p.mat = p.mat
#          ,sig.level = 0.01
#          ,insig = "blank"
#          # hide correlation coefficient on the principal diagonal
#          ,diag=FALSE
#         )

```

Here is an example correlogram with financial data from the peer institutions.

```{r setUpCorrGram2, include=FALSE}

corFin <- df %>%
  select(
    tuition
    ,'Rev' = revnu
    ,'Tui' = revnuTuiPct
    ,'St' = revnuStPct
    ,'Loc' = revnuLocPct
    ,'Exp' = exp
    ,'Instr' = expInstrPct
    ,'AcSp' = expAcSpPct
    ,'StSv' = expStSvPct
    ,'InSp' = expInSpPct
    ,'Sal' = expSalPct
    ,'InSal' = expSalInstr
    ,'AcSpSal' = expSalAcSp
    ,'StSvSal' = expSalStSv
  )
```

```{r printCorrGram2, echo=FALSE}


corrgram(corFin,
         upper.panel = panel.cor
         ,lower.panel = panel.fill
         )


# corrgram(corFin,
#          upper.panel = panel.cor
#          ,lower.panel = panel.pie
#          )

```

It does not take long to detect a strong correlation between revenue (“Rev”) and expenses (“Exp”), but that would be expected. As one quick analysis from this correlogram, I noticed that there is a negative correlation between tuition (“Tui”) and the percentage of revenue generated from local taxes (“Loc”). While a correlation does not imply any sort of causative direction, I would guess that as local taxes decrease for whatever reason the college must increase tuition to make up the difference, but more research would be needed to try to verify that guess.

## Wrapup

Correlation is a very important tool for researchers and *R* provides a number of ways to calculate and interpret correlations. This post has listed a few that I tend to use, but there are many more (several that I'm sure I've never even heard of).