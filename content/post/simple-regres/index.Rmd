---
title: "Simple Regression"
author: "George Self"
date: 2018-10-16T08:00:00-07:00
description: "-- Exploring Simple Regression Models --"
categories: ["r"]
tags: ["correlogram","ggplot","plotly","regression"]
---

```{r setup, include=FALSE}
# Load some libraries
library(tidyverse)
library(here)
library(plotly)
library(corrgram)

# Set the rproj home directory
here::here()
```


```{r prepDF, include=FALSE}

df <- read_csv("peers.csv") %>%
  select(
    id = "unitid"
    ,name = "institution name"
    ,year = "year"
    ,fips = "HD2016.FIPS state code"
    ,sect = "HD2016.Sector of institution"
    ,deg = "HD2016.Degree-granting status"
    ,tuition = "DRVIC2016.Tuition and fees, 2016-17"
    ,priInOn = "DRVIC2016.Total price for in-state students living on campus 2016-17"
    ,priOutOn = "DRVIC2016.Total price for out-of-state students living on campus 2016-17"
    ,priInOff = "DRVIC2016.Total price for in-state students living off campus (not with family)  2016-17"
    ,priInOffFam = "DRVIC2016.Total price for in-state students living off campus (with family)  2016-17"
    ,size = "HD2016.Institution size category"
    ,regn = "HD2016.Bureau of Economic Analysis (BEA) regions"
    ,enrlTtl = "DRVEF2016.Total  enrollment"
    ,enrlFT = "DRVEF2016.Full-time enrollment"
    ,enrlPT = "DRVEF2016.Part-time enrollment"
    ,fteFall = "DRVEF2016.Full-time equivalent fall enrollment"
    ,frstEnrl = "DRVEF2016.First-time degree/certificate-seeking undergraduate enrollment"
    ,tranEnrl = "DRVEF2016.Transfer-in degree/certificate-seeking undergraduate enrollment"
    ,contEnrl = "DRVEF2016.Continuing degree/certificate-seeking undergraduate enrollment"
    ,nodegEnrl = "DRVEF2016.Nondegree/certificate-seeking undergraduate enrollment"
    ,enrlInd = "DRVEF2016.Percent of total enrollment that are American Indian or Alaska Native"
    ,enrlAsn = "DRVEF2016.Percent of total enrollment that are Asian"
    ,enrlBlk = "DRVEF2016.Percent of total enrollment that are Black or African American"
    ,enrlHsp = "DRVEF2016.Percent of total enrollment that are Hispanic/Latino"
    ,enrlHaw = "DRVEF2016.Percent of total enrollment that are Native Hawaiian or Other Pacific Islander"
    ,enrlWhi = "DRVEF2016.Percent of total enrollment that are White"
    ,enrlTwo = "DRVEF2016.Percent of total enrollment that are two or more races"
    ,enrlUnk = "DRVEF2016.Percent of total enrollment that are Race/ethnicity unknown"
    ,enrlAli = "DRVEF2016.Percent of total enrollment that are Nonresident Alien"
    ,enrlPac = "DRVEF2016.Percent of total enrollment that are Asian/Native Hawaiian/Pacific Islander"
    ,enrlFem = "DRVEF2016.Percent of total enrollment that are women"
    ,sfr = "EF2016D.Student-to-faculty ratio"
    ,retFT = "EF2016D.Full-time retention rate, 2016"
    ,retPT = "EF2016D.Part-time retention rate, 2016"
    ,enrlAdlt = "DRVEF2016.Adult age (25-64) enrollment, all students"
    ,enrl18 = "DRVEF2016.Percent of undergraduate enrollment under 18"
    ,enrl1824 = "DRVEF2016.Percent of undergraduate enrollment 18-24"
    ,enrl2564 = "DRVEF2016.Percent of undergraduate enrollment, 25-64"
    ,enrl65 = "DRVEF2016.Percent of undergraduate enrollment over 65"
    ,frstInNum = "DRVEF2016.Number of first-time undergraduates - in-state"
    ,frstInPct = "DRVEF2016.Percent of first-time undergraduates - in-state"
    ,frstOutNum = "DRVEF2016.Number of first-time undergraduates - out-of-state"
    ,frstOutPct = "DRVEF2016.Percent of first-time undergraduates - out-of-state"
    ,deOnly = "DRVEF2016.Percent of students enrolled exclusively in distance education courses"
    ,deSome = "DRVEF2016.Percent of students enrolled in some but not all distance education courses"
    ,dePct = "DRVEF2016.Percent of students not enrolled in any distance education courses"
    ,asoc = "DRVC2016.Associate's degree"
    ,cert1 = "DRVC2016.Certificates of less than 1-year"
    ,cert12 = "DRVC2016.Certificates of 1 but less than 2-years"
    ,asocNum = "DRVC2016.Number of students receiving an Associate's degree"
    ,cert1Num = "DRVC2016.Number of students receiving a certificate of less than 1-year"
    ,cert12Num = "DRVC2016.Number of students receiving a certificate of 1 but less than 4-years"
    ,gradTtl = "DRVGR2016.Graduation rate, total cohort"
    ,gradMal = "DRVGR2016.Graduation rate, men"
    ,gradFem = "DRVGR2016.Graduation rate, women"
    ,tranTtl = "DRVGR2016.Transfer-out rate, total cohort"
    ,gradPell = "DRVGR2016.Pell Grant recipients - Overall graduation rate within 150 percent of normal time"
    ,gradNoFa = "DRVGR2016.Did not receive Pell Grants or Subsidized Stafford Loans - Overall graduation rate within 150 percent of normal time"
    ,grad100 = "GR200_16.Graduation rate - degree/certificate within 100% of normal time"
    ,faPct = "SFA1516.Percent of full-time first-time undergraduates awarded any financial aid"
    ,faFedPct = "SFA1516.Percent of full-time first-time undergraduates awarded federal, state, local or institutional grant aid"
    ,faFedAmt = "SFA1516.Average amount of federal, state, local or institutional grant aid awarded"
    ,pellPct = "SFA1516.Percent of full-time first-time undergraduates awarded Pell grants"
    ,pellAmt = "SFA1516.Average amount of Pell grant aid awarded to full-time first-time undergraduates"
    ,loanPct = "SFA1516.Percent of full-time first-time undergraduates awarded student loans"
    ,loanAmt = "SFA1516.Average amount of student loans awarded to full-time first-time undergraduates"
    ,revnu = "DRVF2016.Core revenues, total dollars (GASB)"
    ,revnuTuiPct = "DRVF2016.Tuition and fees as a percent of core revenues (GASB)"
    ,revnuStPct = "DRVF2016.State appropriations as percent of core revenues  (GASB)"
    ,revnuLocPct = "DRVF2016.Local appropriations as a percent of core revenues (GASB)"
    ,revnuTuiFte = "DRVF2016.Revenues from tuition and fees per FTE (GASB)"
    ,revnuStFte = "DRVF2016.Revenues from state appropriations per FTE (GASB)"
    ,revnuLocFte = "DRVF2016.Revenues from local appropriations per FTE (GASB)"
    ,exp = "DRVF2016.Core expenses, total dollars (GASB)"
    ,expInstrPct = "DRVF2016.Instruction expenses as a percent of total core expenses (GASB)"
    ,expAcSpPct = "DRVF2016.Academic support expenses as a percent of total core expenses (GASB)"
    ,expStSvPct = "DRVF2016.Student service expenses as a percent of total core expenses (GASB)"
    ,expInSpPct = "DRVF2016.Institutional support expenses as a percent of total core expenses (GASB)"
    ,expInstrFte = "DRVF2016.Instruction expenses per FTE  (GASB)"
    ,expAcSpFte = "DRVF2016.Academic support expenses per FTE (GASB)"
    ,expStSvFte = "DRVF2016.Student service expenses per FTE (GASB)"
    ,expInSpFte = "DRVF2016.Institutional support expenses per FTE (GASB)"
    ,expSalPct = "DRVF2016.Salaries and wages for core expenses as a percent of total core expenses (GASB)"
    ,expSalInstr = "DRVF2016.Salaries and wages for instruction as a percent of total expenses for instruction (GASB)"
    ,expSalAcSp = "DRVF2016.Salaries and wages for academic support as a percent of total expenses for academic support (GASB)"
    ,expSalStSv = "DRVF2016.Salaries and wages for student services as a percent of total expenses for student services (GASB)"
    ,expSalInSp = "DRVF2016.Salaries and wages for institutional support as a percent of total expenses for institutional support (GASB)"
    ,expSalAvr = "DRVHR2016.Average salary equated to 9 months of full-time instructional staff - all ranks"
    ,fteStf = "DRVHR2016.Total FTE staff"
    ,fteInstr = "DRVHR2016.Instructional FTE"
    ,fteLib = "DRVHR2016.Librarians, Curators, and Archivists/Student and Academic Affairs and Other Education Services FTE"
    ,fteStSv = "DRVHR2016.Student and Academic Affairs and Other Education Services FTE"
    ,fteMgmt = "DRVHR2016.Management FTE"
    ,fteBus = "DRVHR2016.Business and Financial Operations FTE"
    ,fteCmptr = "DRVHR2016.Computer, Engineering, and Science FTE"
    ,fteAdmSp = "DRVHR2016.Service, sales, office/admin support, natural resources, construction, maintenance, production, transportation & materials moving FTE"
    ,priFa = "SFA1516.Average net price-students awarded grant or scholarship aid, 2015-16"
    ,phyBks = "DRVAL2016.Physical books as a percent of the total library collection"
    ,phyMed = "DRVAL2016.Physical media as a percent of the total library collection"
    ,phySer = "DRVAL2016.Physical serials as a percent of the total library collection"
    ,dbLib = "DRVAL2016.Databases as a percent of the total library collection"
    ,libSal = "DRVAL2016.Salaries and wages from the library budget as a percent of total library expenditures"
    ,libBkPrch = "DRVAL2016.One-time purchases of books, serial backfiles, and other materials as a percent of total library expenditures"
    ,expLibFte = "DRVAL2016.Total library expenditures per FTE"
    ,addr = "HD2016.Street address or post office box"
    ,city = "HD2016.City location of institution"
    ,state = "HD2016.State abbreviation"
    ,zip = "HD2016.ZIP code"
    ,url = "HD2016.Institution's internet website address"
    ,county = "HD2016.County name"
    ,long = "HD2016.Longitude location of institution"
    ,lat = "HD2016.Latitude location of institution"
  )

```


## Simple Regression

For this blog post, the Cochise College IPEDs Peer data frame will be used. That data frame was first seen in Introduction to IPEDS Peers (August 24, 2018). That data frame includes 113 attributes for 29 colleges and it is natural to wonder if any of those attributes are related to each other in such a way that they can be used for predictions. The relationships between selected attributes was explored in About Correlation where two Correlograms were generated to find highly-correlated attributes. This post will use several attributes from the IPEDS data as factors in a regression analysis to see if a model can be developed that will predict the value of one attribute when given the value of another.

Here is a correlogram with the race/ethnicity attribute along with the tuition charged.

```{r reg02, include=FALSE}

reg02 <- df %>%
  select(
     'Tuition' = tuition #Tuition & fees/year/full-time student
    ,'Indian' = enrlInd #Percent American Indian or Alaska Native
    ,'Asian' =  enrlAsn #PercentAsian
    ,'Black' = enrlBlk #Percent Black
    ,'Hispanic' = enrlHsp #Percent Hispanic
    ,'Hawaiian' = enrlHaw #Percent Hawaiian
    ,'White' = enrlWhi #Percent White
    ,'Two' = enrlTwo #Percent Two or more
    ,'Alien' = enrlAli #Percent Nonresident Alien
    ,'Unk' = enrlUnk #Percent Unknown
  )

```

```{r corrgramReg02, echo=FALSE}


corrgram(reg02,
         upper.panel = panel.cor
         ,lower.panel = panel.fill
         )

```

This correlogram has some interesting correlations, but I suspect that those are a factor of nothing more than geography. Community colleges tend to attract local students so the student demographics would tend to mirror the local population. Thus, there is a strong negative correlation indicated between black and white students and between Hispanic and white students. I suspect that this does not indicate one race refusing to go to college with another but, rather, that the communities where colleges are located are somewhat polarized.

For this analysis, I wanted to determine if tuition has an influence on the ethnic makeup of the student body. At just a quick glance, I can see that there is a moderate positive correlation between tuition and white students and a moderate negative correlation between tuition and Hispanic students.

Two simple linear models will be developed with *R* and then those models will be used to predict the percent of Hispanic and White students when given a specific tuition. 

The general regression formula is \(\hat{y}=\beta_1x+\beta_0\) where the output (\(\hat{y}\) is determined by two parameters of the model (\(\beta\) and the input (\(x\). As an example, if \(\beta_1\) is 2 and \(\beta_0\) is 1 then an input (\(x\) of 1 would yield an output (\(\hat{y}\) of 3.

```{r lmod1Hisp, echo=FALSE}

lmod1 <- lm(Hispanic ~ Tuition, reg02)
b1 <- coef(lmod1)[[1]] # y-intercept
m1 <- coef(lmod1)[[2]] # slope

# Now, specify the value of x
x1 <- 3000.0

# Calculate the regression
#cat('Prediction for ',x1,' is: ',(m1 * x1) + b1,'\n')

#lmod1

```


To create the regression model, I focused first on the relationship between the percentage of Hispanic students (the dependent variable) and tuition (the independent variable). *R* has a linear model function, *lm(Hispanic ~ Tuition)* that was used to determine the values of \(\beta_0\) and \(\beta_1\). Plugging those values into the regression formula yielded \(\hat{y}=-0.011x+58.13\). Now, to calculate the predicted percent of Hispanic students for a tuition of $3,000, plug that number in for \(x\) and solve the equation (it comes out to 25.21%). 

It may be easier to visualize this relationship with a scatter plot that shows the relationship between those two variables along with a line of best fit for the data.

```{r ggplotPointHisp, echo=FALSE}

p1 <- ggplot(data = reg02, aes(x = Tuition, y = Hispanic)) +
  geom_point() +
  theme_bw() +
  labs(title = "Percent of Hispanic Students vs Tuition", 
       x = "Tuition/student/year", 
       y = "Percent of Hispanic Students") +
  geom_smooth(method = 'lm'
              ,se = FALSE
              ,color = 'blue'
              ) +
  geom_ribbon(stat = 'smooth'
              ,method = 'lm'
              ,alpha = .15)

ggplotly(p1)

```

In the above plot, the various colleges in the IPEDS peer group are indicated by the black dots and the blue line is the line of best fit. Because it is a negative correlation the blue line angles downward. The gray zone indicates a 95% confidence level for the true value of the line of best fit. This is an interactive chart and a prediction can be made by simply hovering the mouse over the line of best fit to see the values of Tuition and Percent of Students. 

Next, I focused on the relationship between the percentage of White students (the dependent variable) and tuition (the independent variable). Here is a scatter plot that shows that relationship along with a line of best fit for the data.

```{r ggplotPointWhite, echo=FALSE}

p2 <- ggplot(data = reg02, aes(x = Tuition, y = White)) +
  geom_point() +
  theme_bw() +
  labs(title = "Percent of White Students vs Tuition", 
       x = "Tuition/student/year", 
       y = "Percent of White Students") +
  geom_smooth(method = 'lm'
              ,se = FALSE
              ,color = 'darkred'
              ) +
  geom_ribbon(stat = 'smooth'
              ,method = 'lm'
              ,alpha = .15)

ggplotly(p2)

```



```{r lmod2White, echo=FALSE}

lmod2 <- lm(White ~ Tuition, reg02)
b2 <- coef(lmod2)[[1]] # y-intercept
m2 <- coef(lmod2)[[2]] # slope

# Now, specify the value of x
x2 <- 3000.0

# Calculate the regression
# cat('Prediction for ',x2,' is: ',(m2 * x2) + b2,'\n')

#lmod2

```


For example, on the plot of white students, if the mouse is hovered over the line above the value of $3000 for Tuition then the percentage of white students is 47.

While this is an interesting exercise, any sort of cause and effect discussion should  be avoided. As the percentage of white students increase is there pressure to increase tuition (perhaps due to services demanded by the student body)? Or does higher tuition tend to deter students of color? Of course, there are many other factors not considered in this simple analysis, like the geographic community where the college is located or the availability of financial aid.

## Multiple Regression

It is possible to have more than one variable influence the output and in that case a multiple regression is used for predictions. For this part of the post I decided to use the three income streams to predict the core revenue available. The three streams are the percent of the core revenue provided by tuition, the percent of the core revenue provided by local funding, and the percent of the core revenue provided by state funding. This is a simplified view of revenue and ignores sources like grants, but is adequate for this analysis.

The first step was to construct a correlogram to get a sense of the relationship between these factors. According to this chart the local revenue has a moderate correlation to total revenue but neither the state or tutition has much of a correlation.

```{r reg03, include=FALSE}

reg03 <- df %>%
  select(
     'Revenue' = revnu # Core revenues, total dollars
    ,'Tuition' = revnuTuiPct # Tuition and fees as percent of core revenues
    ,'State' = revnuStPct # State appropriations as percent of core revenues
    ,'Local' = revnuLocPct # Local appropriations as a percent of core revenues
  )


```

```{r corrgramReg03, echo=FALSE}


corrgram(reg03,
         upper.panel = panel.cor
         ,lower.panel = panel.fill
         )

```

The general multiple regression formula is \(\hat{y}=\beta_1x_1+\beta_2x_2+\beta_0\) where the output (\(\hat{y}\) is determined by three parameters of the model (\(\beta\) and the inputs (\(x\). For the revenue regression, there are three input variables (tuition, state, local) that is used to predict the core revenue. In *R* the formula is *lm(Revenue ~ Tuition+State+Local)*



```{r lmod3MultReg, echo=FALSE}

lmod3 <- lm(Revenue ~ Tuition+State+Local, reg03)
b31 <- coef(lmod3)[[1]] # y-intercept
m31 <- coef(lmod3)[[2]] # slope Tuition
m32 <- coef(lmod3)[[3]] # slope State
m33 <- coef(lmod3)[[4]] # slope Local

# Now, specify the value of x
x31 <- 12.0 #Tuition
x32 <- 23.0 #State
x33 <- 42.0 #Local

# Calculate the regression
#cat('Prediction for ',x31, '/', x32, '/', x33, ' is: ',(m31 * x31) + (m32 * x32) + (m33 * x33) + b31,'\n')

#lmod3

```

This is the regression formula that was generated from the IPEDS peer data. \(\hat{y}=(962285*x_1)+(956919*x_2)+(1312015*x_3)+1953830\). That linear model was used to create the following scatter plot.

```{r ggplotPointMultReg, echo=FALSE}

p3 <- ggplot(data = reg03) +
  geom_point(aes(x = Tuition, y = Revenue), # Tuition (Blue)
             shape = 18,
             color = '#2ca7ff') +
  geom_smooth(aes(x = Tuition, y = Revenue), 
              method = lm, 
              color = '#2ca7ff', 
              se = FALSE) +
  geom_point(aes(x = State, y = Revenue), # State (Gold)
             shape = 15,
             color = '#ffae2c') +
  geom_smooth(aes(x = State, y = Revenue), 
              method = lm, 
              color = '#ffae2c',
              se = FALSE) +
  geom_point(aes(x = Local, y = Revenue), # Local (Red)
             shape = 16,
             color = '#ff412c') +
  geom_smooth(aes(x = Local, y = Revenue), 
              method = lm,
              color = '#ff412c',
              se = FALSE) +
  theme_bw() +
  labs(title = "Revenue Sources vs Total Core Revenue",
       x = "Revenue Source Percentages",
       y = "Total Core Revenue")

ggplotly(p3)

```

In the above plot, the tuition percentages are in blue, the state percentages are in gold, and the local percentages are in red. Notice that the local percentages seem to make the greatest difference since the slope of that line is greater than the other two. The state percentages seem to be the least important since the slope on that line is nearly flat. 

There is little to be gained from hovering over each line, though the value of the X and Y variables will be displayed. To determine the impact of changing one of the three percentages would require a way to change the percentage (a "slider" control), but that is a project for another day.

